import re
import sys

cmdExecutionFunctions = ['shell_exec','system','exec','popen','passthru','proc_open','pcntl_exec','eval','assert','create_function','preg_replace','include','require']
parameters = ['$_GET','$_POST', '$_REQUEST']
variables = []
requestParams = []
queries = []

pattern = re.compile(r"(\$\w+)(\s*=\s*)(\$_(GET|POST|REQUEST)\[\')(.*)(\'\])")
queryPattern = re.compile(r"(SELECT|INSERT|UPDATE|DELETE)(.*?)(;)")


def findAllUserControlledVars(filename):
	with open(filename) as file:
		for num, line in enumerate(file,1):
			matches = pattern.search(line)
			if matches:
				variables.append(matches.group(1))
				requestParams.append(matches.group(5))
		file.close()

def isQueryVulnerable(query):
	for variable in variables:
		if query.find(variable) != -1:
			return True
	if query.find('$_GET') or query.find('$_POST'):
		return True;
	return False

def findAllVulnerableQueries(filename):
	with open(filename) as file:
		data = file.read()
		data = data.replace('\n',' ')
		for match in re.finditer(queryPattern,data):
			query = match.group()
			if isQueryVulnerable(query):
				queries.append(query)
		file.close()

def findPotentialXSSVulnerability(filename):
	print '----------------------Potential XSS Vulnerabilities-------------------------'
	with open(filename) as file:
		for num, line in enumerate(file,1):
			if line.find('echo') != -1 and (any(var in line for var in variables) or 
				any(params in line for params in parameters)):
				print "Potential XSS on line number " + str(num) + " " +line
		file.close()


def areVulnerableFunctionsPresent(filename):
	with open(filename) as file:
		for num, line in enumerate(file,1):
			if any(func in line for func in cmdExecutionFunctions):
				print "Potential Command Injection " + str(num) + " " +line
		file.close()
				

findAllUserControlledVars(sys.argv[1])
findAllVulnerableQueries(sys.argv[1])
findPotentialXSSVulnerability(sys.argv[1])
areVulnerableFunctionsPresent(sys.argv[1])

print"--------------------USER CONTROLLED VARIABLES------------------------"
for var in variables:
	print var
print"--------------------VULNERABLE QUERIES-------------------------------"
for query in queries:
	print query
